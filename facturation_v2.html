<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF FINANCE - Facturation</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <img id="logo-source" src="Logo.png" style="display: none;" crossorigin="anonymous">
    
    <datalist id="clients_suggestions"></datalist>
    <datalist id="fournisseurs_list"><option value="Bernier Cercueils"><option value="Total Énergies"><option value="Fleuriste Partenaire"></datalist>

    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-dove"></i> <span class="brand-text">PF FINANCE</span>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html" class="nav-link"><i class="fas fa-arrow-left"></i> <span class="nav-text">Retour ERP</span></a></li>
            <li><a href="#" onclick="location.reload()" class="nav-link active"><i class="fas fa-chart-line"></i> <span class="nav-text">Pilotage</span></a></li>
        </ul>
    </nav>

    <main class="main-content">
        
        <div id="view-dashboard">
            <div class="page-header">
                <h1>Pilotage Financier</h1>
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="window.switchTab('factures')" id="btn-tab-factures">VENTES</button>
                    <button class="tab-btn" onclick="window.switchTab('achats')" id="btn-tab-achats">ACHATS</button>
                </div>
            </div>

            <div class="dashboard-grid stats-grid">
                <div class="card" style="border-bottom: 4px solid #10b981;">
                    <div style="font-size:0.8rem; color:#64748b;">CHIFFRE D'AFFAIRES</div>
                    <div id="stat-ca" style="font-size:1.8rem; font-weight:800;">0.00 €</div>
                </div>
                <div class="card" style="border-bottom: 4px solid #ef4444;">
                    <div style="font-size:0.8rem; color:#64748b;">DÉPENSES</div>
                    <div id="stat-depenses" style="font-size:1.8rem; font-weight:800;">0.00 €</div>
                </div>
                <div class="card" style="border-bottom: 4px solid #3b82f6;">
                    <div style="font-size:0.8rem; color:#64748b;">RÉSULTAT NET</div>
                    <div id="stat-resultat" style="font-size:1.8rem; font-weight:800;">0.00 €</div>
                </div>
            </div>

            <div id="tab-factures">
                <div style="margin-bottom:15px; display:flex; justify-content:space-between;">
                    <input type="text" placeholder="Rechercher..." style="width:250px;">
                    <button class="btn btn-blue" onclick="window.nouveauDocument()"><i class="fas fa-plus"></i> CRÉER DEVIS</button>
                </div>
                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="history-table">
                        <thead><tr><th>N°</th><th>Date</th><th>Type</th><th>Client</th><th>Défunt</th><th style="text-align:right;">Total</th><th style="text-align:right;">Reste</th><th>Actions</th></tr></thead>
                        <tbody id="list-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-achats" class="hidden">
                <div class="card" style="border-left: 4px solid #ef4444;">
                    <h3>Nouvelle Dépense</h3>
                    <form id="dep_form" class="form-grid" onsubmit="return false;">
                        <input type="hidden" id="dep_edit_id">
                        <div><label>Date</label><input type="date" id="dep_date_fac"></div>
                        <div><label>Fournisseur</label><input id="dep_fourn" list="fournisseurs_list"></div>
                        <div><label>Réf.</label><input id="dep_ref"></div>
                        <div><label>Catégorie</label><select id="dep_cat"><option>Marchandise</option><option>Frais Généraux</option><option>Carburant</option></select></div>
                        <div><label>Détails</label><input id="dep_details"></div>
                        <div><label>Montant TTC</label><input type="number" id="dep_montant"></div>
                        <div><label>Paiement</label><select id="dep_mode"><option>Virement</option><option>CB</option></select></div>
                        <div><label>Statut</label><select id="dep_statut"><option>Réglé</option><option>En attente</option></select></div>
                        <div><label>Date Règlement</label><input type="date" id="dep_date_reg"></div>
                        <div style="display:flex; align-items:end;"><button class="btn btn-red" onclick="window.gererDepense()" style="width:100%;">ENREGISTRER</button></div>
                    </form>
                </div>
                <div style="margin:15px 0;"><input id="search_depense" placeholder="Filtrer les achats..." style="width:100%;" onkeyup="window.filtrerDepenses()"></div>
                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="history-table">
                        <thead><tr><th>Date</th><th>Fournisseur</th><th>Réf</th><th>Statut</th><th style="text-align:right;">Montant</th><th>Action</th></tr></thead>
                        <tbody id="depenses-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-editor" class="hidden">
            <input type="hidden" id="current_doc_id">
            <div class="page-header">
                <button class="btn btn-icon" onclick="window.showDashboard()"><i class="fas fa-arrow-left"></i> Retour</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-blue" id="btn-pdf"><i class="fas fa-print"></i> PDF</button>
                    <button class="btn btn-green" onclick="window.sauvegarderDocument()"><i class="fas fa-save"></i> SAUVEGARDER</button>
                </div>
            </div>

            <div class="form-grid">
                <div class="card">
                    <h3>CLIENT</h3>
                    <div style="display:flex; gap:5px;"><select id="client_civility" style="width:70px;"><option>M.</option></select><input id="client_nom" list="clients_suggestions" placeholder="Nom Client" style="flex:1;"></div>
                    <input id="client_adresse" placeholder="Adresse complète" style="margin-top:5px;">
                </div>
                <div class="card">
                    <h3>INFOS DOCUMENT</h3>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <select id="doc_type" style="width:100px;"><option>DEVIS</option><option>FACTURE</option></select>
                        <input id="doc_numero" placeholder="N° Auto" style="font-weight:bold;">
                    </div>
                    <input type="date" id="doc_date">
                    <div style="display:flex; gap:5px; margin-top:5px;"><select id="defunt_civility" style="width:70px;"><option>M.</option></select><input id="defunt_nom" placeholder="Concernant le défunt..."></div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3>LIGNES</h3>
                    <button class="btn btn-blue" onclick="window.ajouterLigne()">+ LIGNE</button>
                </div>
                <table style="width:100%; text-align:left;">
                    <thead><tr><th width="30"></th><th>Désignation</th><th width="120">Type</th><th width="100" style="text-align:right;">Prix</th><th width="30"></th></tr></thead>
                    <tbody id="tbody_lignes"></tbody>
                </table>
            </div>

            <div class="form-grid" style="margin-top:20px;">
                <div class="card" style="background:#ecfccb;">
                    <h3>PAIEMENTS REÇUS</h3>
                    <div style="display:flex; gap:5px;">
                        <input type="date" id="pay_date">
                        <select id="pay_mode"><option>Virement</option><option>Chèque</option><option>Espèces</option></select>
                        <input type="number" id="pay_amount" placeholder="€">
                        <button class="btn btn-green" onclick="window.ajouterPaiement()">+</button>
                    </div>
                    <div id="liste_paiements" style="margin-top:10px;"></div>
                </div>
                <div class="card" style="text-align:right;">
                    <div>TOTAL TTC : <strong id="total_general" style="font-size:1.2rem;">0.00 €</strong></div>
                    <div style="color:#166534;">DÉJÀ REGLÉ : <strong id="total_paye">0.00 €</strong></div>
                    <div style="color:#b91c1c; font-size:1.5rem; margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">RESTE : <strong id="reste_a_payer">0.00 €</strong></div>
                    <span id="total_display" class="hidden">0</span>
                </div>
            </div>
        </div>

    </main>

    <script type="module" src="js/facturation.js"></script>
    
    <script>
        document.getElementById('btn-pdf').addEventListener('click', () => {
            const lignes = [];
            document.querySelectorAll('#tbody_lignes tr').forEach(tr => {
                lignes.push({ desc: tr.querySelector('.val-desc').value, type: 'item', prix: parseFloat(tr.querySelector('.val-prix').value)||0, cat: tr.querySelector('.val-type').value });
            });
            const data = {
                client: { civility: document.getElementById('client_civility').value, nom: document.getElementById('client_nom').value, adresse: document.getElementById('client_adresse').value },
                defunt: { civility: document.getElementById('defunt_civility').value, nom: document.getElementById('defunt_nom').value },
                info: { type: document.getElementById('doc_type').value, date: document.getElementById('doc_date').value, numero: document.getElementById('doc_numero').value, total: parseFloat(document.getElementById('total_display').innerText) },
                lignes: lignes, paiements: [] // Paiements gérés par variable globale dans le module
            };
            // On appelle la fonction exposée par le module
            if(window.generatePDFFromData) window.generatePDFFromData(data, true);
        });
    </script>
</body>
</html>