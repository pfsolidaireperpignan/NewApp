<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF FINANCE - Facturation</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
    <img id="logo-source" src="Logo.png" style="display: none;" crossorigin="anonymous">
    
    <datalist id="clients_suggestions"></datalist>
    <datalist id="defunts_suggestions"></datalist>
    <datalist id="fournisseurs_list">
        <option value="Bernier Cercueils"><option value="Total √ânergies"><option value="Assurance Allianz"><option value="Fournitures Bureau"><option value="Loyer Local"><option value="Urnes Fun√©raires"><option value="Fleuriste Partenaire">
    </datalist>

    <div id="modal-choix" class="modal hidden">
        <div class="modal-content">
            <h3 style="color:#1e293b; margin-top:0;">CHOISIR UN MOD√àLE</h3>
            <button class="modal-btn" onclick="window.loadTemplate('Inhumation')"><i class="fas fa-church"></i> INHUMATION</button>
            <button class="modal-btn" onclick="window.loadTemplate('Cremation')"><i class="fas fa-fire"></i> CR√âMATION</button>
            <button class="modal-btn" onclick="window.loadTemplate('Rapatriement')"><i class="fas fa-plane"></i> RAPATRIEMENT</button>
            <button class="modal-btn" onclick="window.loadTemplate('Transport')"><i class="fas fa-ambulance"></i> TRANSPORT</button>
            <button class="modal-btn" onclick="window.loadTemplate('Exhumation')"><i class="fas fa-box-open"></i> EXHUMATION</button>
            <div style="margin-top:10px;"><a href="#" onclick="document.getElementById('modal-choix').classList.add('hidden')" style="color:#ef4444;">Annuler</a></div>
        </div>
    </div>

    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-dove"></i> 
            <span class="brand-text">PF ERP</span> 
            <span style="font-size:0.5em; color:var(--gray); font-weight:400; margin-left:5px;" class="brand-text">v17</span>
            <button id="btn-toggle-menu" onclick="window.toggleSidebar()" style="margin-left:auto; border:none; background:transparent; cursor:pointer; color:var(--gray);">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="index.html" class="nav-link"><i class="fas fa-home"></i> <span class="nav-text">Accueil</span></a></li>
            <li class="nav-item"><a href="index.html" class="nav-link"><i class="fas fa-folder-open"></i> <span class="nav-text">Dossier Admin</span></a></li>
            <li class="nav-item"><a href="index.html" class="nav-link"><i class="fas fa-users"></i> <span class="nav-text">Base Clients</span></a></li>
            <li class="nav-item"><a href="index.html" class="nav-link"><i class="fas fa-boxes"></i> <span class="nav-text">Gestion Stock</span></a></li>
            <li class="nav-item"><a href="#" onclick="location.reload()" class="nav-link active"><i class="fas fa-file-invoice-dollar"></i> <span class="nav-text">Facturation</span></a></li>
            <li class="nav-item">
                <a href="dossier_complet.html" class="nav-link" style="color:#ea580c;">
                    <i class="fas fa-layer-group"></i> <span class="nav-text">Atelier Dossier</span>
                </a>
            </li>
            <li class="nav-item" style="margin-top:auto;"><a href="#" onclick="window.logout()" class="nav-link" style="color:#ef4444;"><i class="fas fa-power-off"></i> <span class="nav-text">D√©connexion</span></a></li>
        </ul>
    </nav>

    <div class="main-content">
        <div id="view-dashboard">
            <div class="dashboard-header">
                <div>
                    <h1 style="margin:0;">Pilotage Financier</h1>
                    <div class="nav-tabs" style="margin-top:10px; display:flex; gap:10px;">
                        <button class="tab-btn active" onclick="window.switchTab('factures')" id="btn-tab-factures"><i class="fas fa-file-invoice"></i> FACTURES CLIENTS</button>
                        <button class="tab-btn" onclick="window.switchTab('achats')" id="btn-tab-achats"><i class="fas fa-shopping-cart"></i> REGISTRE ACHATS</button>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <button onclick="window.exporterExcelSmart()" class="btn btn-green" style="background-color:#10b981;">
                        <i class="fas fa-file-excel"></i> EXPORT EXCEL
                    </button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card card-ca">
                    <div class="stat-label">Chiffre d'Affaires</div>
                    <div class="stat-value" id="stat-ca">0.00 ‚Ç¨</div>
                    <div class="stat-year" id="year-display-1">2026</div>
                    <i class="fas fa-arrow-up" style="position:absolute; bottom:20px; right:20px; font-size:2rem; opacity:0.1;"></i>
                </div>
                <div class="stat-card card-depense">
                    <div class="stat-label">D√©penses</div>
                    <div class="stat-value" id="stat-depenses">0.00 ‚Ç¨</div>
                    <div class="stat-year" id="year-display-2">2026</div>
                    <i class="fas fa-arrow-down" style="position:absolute; bottom:20px; right:20px; font-size:2rem; opacity:0.1;"></i>
                </div>
                <div class="stat-card card-result">
                    <div class="stat-label">R√©sultat Net</div>
                    <div class="stat-value" id="stat-resultat">0.00 ‚Ç¨</div>
                    <div class="stat-year" id="year-display-3">2026</div>
                    <i class="fas fa-piggy-bank" style="position:absolute; bottom:20px; right:20px; font-size:2rem; opacity:0.1;"></i>
                </div>
            </div>

            <div id="tab-factures">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                    <input type="text" id="search-input" placeholder="Rechercher facture..." style="padding:10px; width:250px;">
                    <button class="btn btn-blue" onclick="document.getElementById('modal-choix').classList.remove('hidden')"><i class="fas fa-plus"></i> CR√âER UN DEVIS</button>
                </div>
                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="compta-table">
                        <thead><tr><th>Num√©ro</th><th>Date</th><th>Type</th><th>Client</th><th>D√©funt</th><th style="text-align:right;">Montant TTC</th><th style="text-align:right;">Reste √† Payer</th><th style="text-align:center;">Actions</th></tr></thead>
                        <tbody id="list-body"><tr><td colspan="8" style="text-align:center; padding:30px;">Chargement...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-achats" class="hidden">
                <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #cbd5e1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="font-weight:bold; color:#475569;"><i class="fas fa-filter"></i> RECHERCHE & FILTRES</div>
                        <div style="background:white; padding:8px 15px; border-radius:6px; border-left:4px solid #c2410c; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                            <span style="font-size:0.85rem; color:#64748b; text-transform:uppercase;">Reste √† payer :</span>
                            <strong id="total-dette-filtre" style="color:#c2410c; font-size:1.3rem; margin-left:10px;">0.00 ‚Ç¨</strong>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <input type="text" id="search_depense" placeholder="üîç Nom, R√©f√©rence..." style="flex:2; padding:10px; border:1px solid #94a3b8; border-radius:6px; min-width:200px;" onkeyup="window.filtrerDepenses()">
                        <select id="filter_year" onchange="window.filtrerDepenses()" style="flex:1; padding:10px; border:1px solid #94a3b8; border-radius:6px;">
                            <option value="">Ann√©es</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
                        </select>
                        <select id="filter_month" onchange="window.filtrerDepenses()" style="flex:1; padding:10px; border:1px solid #94a3b8; border-radius:6px;">
                            <option value="">Mois</option>
                            <option value="0">Janv</option><option value="1">F√©vr</option><option value="2">Mars</option><option value="3">Avr</option><option value="4">Mai</option><option value="5">Juin</option><option value="6">Juil</option><option value="7">Ao√ªt</option><option value="8">Sept</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">D√©c</option>
                        </select>
                    </div>
                </div>

                <div class="expense-form" id="form-depense">
                    <input type="hidden" id="dep_edit_id"> 
                    <div style="width:100%; display:flex; gap:15px; margin-bottom:10px;">
                        <div class="form-group" style="flex:1;"><label>Date Facture</label><input type="date" id="dep_date_fac"></div>
                        <div class="form-group" style="flex:1;"><label>R√©f. (N¬∞)</label><input type="text" id="dep_ref" placeholder="Ex: FC-045"></div>
                        <div class="form-group" style="flex:2;"><label>Fournisseur</label><input type="text" id="dep_fourn" list="fournisseurs_list"></div>
                        <div class="form-group" style="flex:1;"><label>R√®glement</label><input type="date" id="dep_date_reg"></div>
                    </div>
                    <div style="width:100%; margin-bottom:10px;"><label>D√©tails / Note</label><input type="text" id="dep_details" placeholder="D√©tails..." style="width:100%;"></div>
                    <div style="width:100%; display:flex; gap:15px; align-items:flex-end;">
                        <div class="form-group" style="flex:1;"><label>Cat√©gorie</label><select id="dep_cat"><option disabled selected>-- Choisir --</option><optgroup label="Marchandises">
                        <option>Achat Cercueils</option><option>Achat Urnes</option><option>Achat Fleurs / Plaques</option></optgroup><optgroup label="Frais G√©n√©raux"><option>Loyer / Charges</option><option>Frais de fret</option><option>√âlectricit√© / Eau</option><option>Assurance Pro</option></optgroup><optgroup label="V√©hicules"><option>Carburant / P√©age</option><option>Entretien V√©hicules</option></optgroup><optgroup label="Divers"><option>Salaires</option><option>Imp√¥ts</option><option>Autre</option></optgroup></select></div>
                        <div class="form-group" style="flex:1;"><label>Paiement</label><select id="dep_mode">
                        <option>Virement</option><option>CB</option><option>Ch√®que</option><option>Esp√®ces</option></select></div>
                        <div class="form-group" style="flex:1;"><label>Statut</label><select id="dep_statut"><option value="R√©gl√©">‚úÖ R√©gl√©</option><option value="En attente">‚è≥ En attente</option></select></div>
                        <div class="form-group" style="flex:1;"><label>Montant TTC</label><input type="number" id="dep_montant" placeholder="0.00"></div>
                        <button id="btn-action-depense" class="btn btn-red" onclick="window.gererDepense()" style="height:40px; margin-bottom:1px; min-width:120px;"><i class="fas fa-plus"></i> SAUVER</button>
                        <button id="btn-cancel-depense" class="btn btn-grey hidden" onclick="window.resetFormDepense()" style="height:40px; margin-bottom:1px;"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <table class="compta-table">
                    <thead><tr><th onclick="window.trierTableau('date')">Dates <i class="fas fa-sort"></i></th><th onclick="window.trierTableau('fournisseur')">Fournisseur <i class="fas fa-sort"></i></th><th onclick="window.trierTableau('categorie')">Cat√©gorie <i class="fas fa-sort"></i></th><th onclick="window.trierTableau('statut')">Statut <i class="fas fa-sort"></i></th><th style="text-align:right;" onclick="window.trierTableau('montant')">Montant <i class="fas fa-sort"></i></th><th style="text-align:center;">Action</th></tr></thead>
                    <tbody id="depenses-body"><tr><td colspan="6" style="text-align:center;">Chargement...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="view-editor" class="hidden editor-container">
            <input type="hidden" id="current_doc_id">
            <div class="top-bar-editor">
                <button onclick="window.showDashboard()" class="btn btn-grey"><i class="fas fa-arrow-left"></i> RETOUR</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-purple hidden" id="btn-transform" onclick="window.transformerEnFacture()"><i class="fas fa-magic"></i> FACTURER</button>
                    <button class="btn btn-green" id="btn-save"><i class="fas fa-save"></i> ENREGISTRER</button>
                    <button class="btn btn-blue" id="btn-pdf"><i class="fas fa-print"></i> PDF</button>
                </div>
            </div>

            <div class="grid-identity">
                <div class="box">
                    <span class="stat-label">CLIENT / MANDANT</span>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <select id="client_civility" class="input-clean" style="width:80px;"><option>M.</option><option>Mme</option></select>
                        <input type="text" class="input-clean" id="client_nom" list="clients_suggestions" onchange="window.remplirInfosClient()" placeholder="Nom Client..." style="flex:1;">
                    </div>
                    <input type="text" class="input-clean" id="client_adresse" placeholder="Adresse compl√®te..." style="margin-top:10px;">
                </div>
                <div class="box">
                    <span class="stat-label">INFORMATIONS</span>
                    <div style="display:flex; gap:10px; margin-bottom:10px; margin-top:5px;">
                        <select id="doc_type" class="input-clean" style="margin:0;"><option>DEVIS</option><option>FACTURE</option></select>
                        <input type="text" id="doc_numero" class="input-clean" style="margin:0; font-weight:bold; color:#d97706;" placeholder="N¬∞ Auto">
                        <input type="date" class="input-clean" id="doc_date" style="margin:0;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="input-clean" id="defunt_nom" list="defunts_suggestions" placeholder="Concerne le d√©funt..." style="flex:1;">
                        <select id="defunt_civility" class="hidden"><option>M.</option></select>
                    </div>
                </div>
            </div>

            <div style="background:white; padding:10px; display:flex; justify-content:space-between; align-items:center; border-radius:8px 8px 0 0; border:1px solid #e2e8f0; margin-top:20px;">
                <div style="font-weight:bold; color:#64748b;">D√âTAIL</div>
                <div>
                    <button class="btn btn-orange" onclick="window.ajouterSection()"><i class="fas fa-heading"></i> SECTION</button>
                    <button class="btn btn-blue" onclick="window.ajouterLigne()"><i class="fas fa-plus"></i> LIGNE</button>
                </div>
            </div>

            <table class="facture-table">
                <thead><tr><th style="width: 30px;"></th><th style="width: 50%;">D√âSIGNATION</th><th style="width: 15%;">TYPE</th><th style="width: 15%; text-align:right;">PRIX TTC</th><th style="width: 5%;"></th></tr></thead>
                <tbody id="tbody_lignes"></tbody>
            </table>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                <div class="payment-box" style="background:#ecfccb; padding:15px; border-radius:8px; border:1px solid #a3e635;">
                    <span class="stat-label" style="color:#166534; font-weight:bold;">ENREGISTRER UN PAIEMENT</span>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <input type="date" id="pay_date" class="input-clean">
                        <select id="pay_mode" class="input-clean"><option>Esp√®ces</option><option>Ch√®que</option><option>Virement</option></select>
                        <input type="number" id="pay_amount" class="input-clean" placeholder="‚Ç¨">
                        <button class="btn btn-green" onclick="window.ajouterPaiement()">+</button>
                    </div>
                    <div id="liste_paiements" style="margin-top:10px; background:white; padding:10px; max-height:100px; overflow-y:auto; border-radius:6px;"></div>
                </div>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:15px; border-radius:8px; text-align:right;">
                    <div style="display:flex; justify-content:space-between;"><span>TOTAL TTC :</span> <strong id="total_general">0.00 ‚Ç¨</strong></div>
                    <div style="display:flex; justify-content:space-between; color:#166534;"><span>D√âJ√Ä R√âGL√â :</span> <strong id="total_paye">0.00 ‚Ç¨</strong></div>
                    <div style="display:flex; justify-content:space-between; font-size:1.4rem; font-weight:bold; color:#b91c1c; border-top:2px solid #ddd; margin-top:10px; padding-top:10px;"><span>RESTE :</span> <span id="reste_a_payer">0.00 ‚Ç¨</span></div>
                    <span id="total_display" class="hidden">0</span>
                </div>
            </div>
        </div>
    </div>

    <button id="mobile-menu-btn" onclick="window.toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div id="mobile-overlay" onclick="window.toggleSidebar()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:4000;"></div>

    <script type="module" src="js/facturation.js"></script>
    
    <script>
        // D√©connexion
        window.logout = function() {
            // Import dynamique pour la d√©connexion
            import('./js/config.js').then(module => {
                import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js').then(authModule => {
                    if(confirm("Se d√©connecter ?")) { authModule.signOut(module.auth).then(() => window.location.href = "index.html"); }
                });
            });
        };

        // Bouton PDF
        document.getElementById('btn-pdf').addEventListener('click', () => {
            const lignes = [];
            document.querySelectorAll('#tbody_lignes tr').forEach(tr => {
                if(tr.classList.contains('row-section')) {
                    lignes.push({ type: 'section', text: tr.querySelector('input').value });
                } else {
                    lignes.push({ 
                        type: 'item', 
                        desc: tr.querySelector('.val-desc').value, 
                        cat: tr.querySelector('.val-type').value, 
                        prix: parseFloat(tr.querySelector('.val-prix').value)||0 
                    });
                }
            });
            const data = {
                client: { civility: document.getElementById('client_civility').value, nom: document.getElementById('client_nom').value, adresse: document.getElementById('client_adresse').value },
                defunt: { civility: document.getElementById('defunt_civility').value, nom: document.getElementById('defunt_nom').value },
                info: { type: document.getElementById('doc_type').value, date: document.getElementById('doc_date').value, numero: document.getElementById('doc_numero').value, total: parseFloat(document.getElementById('total_display').innerText) },
                lignes: lignes, paiements: [] // G√©r√© par le module via variable globale
            };
            if(window.generatePDFFromData) window.generatePDFFromData(data, true);
        });
        
        // Mod√®les rapides
        const MODELES = { "Inhumation": [ { type: 'section', text: 'ORGANISATION' }, { desc: 'D√©marches', prix: 250, cat: 'Courant' }, { type: 'section', text: 'CERCUEIL' }, { desc: 'Cercueil Ch√™ne', prix: 850, cat: 'Courant' } ], "Cremation": [ { type: 'section', text: 'CREMATION' }, { desc: 'Urne', prix: 80, cat: 'Courant' } ], "Rapatriement": [ { type: 'section', text: 'TRANSPORT' }, { desc: 'Soins', prix: 350, cat: 'Courant' }, { desc: 'Cercueil Zinc', prix: 1200, cat: 'Courant' } ] };
        
        window.loadTemplate = async function(type) { 
            document.getElementById('modal-choix').classList.add('hidden'); 
            window.nouveauDocument(); 
            if (MODELES[type]) { 
                document.getElementById('tbody_lignes').innerHTML = ""; 
                MODELES[type].forEach(item => { if(item.type === 'section') window.ajouterSection(item.text); else window.ajouterLigne(item.desc, item.prix, item.cat); }); 
            } 
            window.calculTotal(); 
        };
    </script>
</body>
</html>
